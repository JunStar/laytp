<!DOCTYPE html>
<html lang="zh-cn" class="fullscreen-bg">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>后台登录-LayTp2.0极速后台开发框架</title>
    <link href="/favicon.ico" rel="icon">
    <link rel="stylesheet" href="/static/library/layui/css/layui.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/static/plugin/core/css/style.css">
    <link rel="stylesheet" href="/static/plugin/core/css/prettify.css" media="all">
    <link rel="stylesheet" href="/static/plugin/core/css/login.css" rel="stylesheet">
    <!--[if lt IE 9]>
    <script src="/static/library/html5shiv.min.js"></script>
    <script src="/static/library/respond.min.js"></script>
    <![endif]-->
    <!-- 开始设置全局js常量 -->
    <script type="text/javascript">
        let appName = '';//应用名称
        let controller = '';//控制器
        let action = '';//方法名
        let apiDomain = '';//后台请求接口地址域名。前后端完全分离，后台绑定独立域名，修改此值即可，末尾不要带/
    </script>
    <script type="text/javascript" src="/static/library/layui/layui.js"></script>
</head>
<body style="display:none;">
<div class="login-wrapper">
    <div class="login-header" align="center">
        LayTp2.0极速后台开发框架
        <img src="/static/plugin/core/img/LayTp.png">
    </div>
    <form class="layui-form">
        <h2>后台登录</h2>
        <div class="layui-form-item layui-input-icon-group">
            <i class="layui-icon layui-icon-username"></i>
            <input class="layui-input" name="username" placeholder="请输入登录账号" autocomplete="off"
                   lay-verify="required" required value=""/>
        </div>
        <div class="layui-form-item layui-input-icon-group">
            <i class="layui-icon layui-icon-password"></i>
            <input class="layui-input" name="password" id="password" placeholder="请输入登录密码" type="password"
                   lay-verify="required" required/>
        </div>
        <div class="layui-form-item layui-input-icon-group login-captcha-group">
            <i class="layui-icon layui-icon-auz"></i>
            <input class="layui-input" name="verify_code" id="verify_code" placeholder="请输入验证码" autocomplete="off"
                   lay-verify="required" required/>
            <img class="login-captcha" id="captcha-img" src="/captcha/login"/>
        </div>
        <div class="layui-form-item layui-input-icon-group">
            <input type="checkbox" id="remember" name="remember" title="记住密码" lay-skin="primary" checked="">
        </div>
        <div class="layui-form-item">
            <button class="layui-btn layui-btn-default layui-btn-fluid" id="submitBtn" lay-filter="do-login" lay-submit>
                登录
            </button>
        </div>
    </form>
</div>
<div class="login-footer">
    <p>Copyright © 2020 laytp.com 版权所有</p>
    <p>
        <span><a href="http://www.laytp.com" target="_blank">项目官网</a></span>
        | <span><a href="http://www.laytp.com" target="_blank">社区交流</a></span>
        | <span><a href="https://gitee.com/junstar/laytp2.0" target="_blank">Gitee仓库</a></span>
    </p>
</div>
<script>
    layui.config({
        version: false //一般用于更新模块缓存，默认不开启。设为true即让浏览器不缓存。也可以设为一个固定的值，如：201610
        , debug: false //用于开启调试模式，默认false，如果设为true，则JS模块的节点会保留在页面
        , base: '/static/library/layui/extends/' //设定扩展的Layui模块的所在目录，一般用于外部模块扩展
    }).use(['layTp'], function () {
        let $ = layui.$;
        let form = layui.form;
        let facade = layui.facade;

        //获取是否需要验证码配置项
        facade.ajax({
            path: "plugin/core/common/getLoginNeedCaptchaConf",
            successAlert: false,
            async: false
        }).done(function (res) {
            if (res.data === "0") {
                $(".login-captcha-group").remove();
            }
        });

        //获取token，根据token判断用户是否已经登录，已经登录跳转至后台首页
        let laytpAdminToken = facade.getCookie('laytp_admin_token');
        let isLogin = false;
        if (laytpAdminToken) {
            facade.ajax({path: 'plugin/core/auth.user/info', async: false}).done(function (res) {
                if (res['code'] === 0) {
                    isLogin = true;
                    facade.redirect('/admin/index.html');
                }
            });
        }

        //点击验证码图片，获取新的验证码图片地址
        $("#captcha-img").click(function () {
            this.src = "/captcha/login?v=" + Math.random();
        });

        form.on('submit(do-login)', function (obj) {
            facade.ajax({path: 'plugin/core/auth.login/doLogin', params: obj.field},).done(function (res) {
                if (res['code'] === 0) {
                    let days = 0;
                    if (obj.field.remember === 'on') {
                        days = 365;
                    }
                    facade.setCookie('laytp_admin_token', res['data']['laytp_admin_token'], days);
                    facade.redirect('/admin/index.html');
                } else {
                    $("#captcha-img").click();
                }
            });
            return false;
        });

        let theme = facade.getCookie("theme");
        if (!theme) {
            theme = 21;
        }
        $("body").attr("class", "layui-layout-body laytp-theme-" + theme);
        if (!isLogin) {
            $("body").show();
        }
    });
</script>
</body>
</html>